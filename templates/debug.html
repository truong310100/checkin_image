{% extends "base.html" %}

{% block title %}Debug - Kiểm tra hệ thống{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-warning text-dark py-3">
                <h4 class="mb-0">
                    <i class="fas fa-bug me-2"></i>
                    Debug - Kiểm tra hệ thống
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <button id="checkUsers" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-users me-2"></i>Kiểm tra Users trong Database
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="testRecognition" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-camera me-2"></i>Test nhận diện khuôn mặt
                        </button>
                    </div>
                </div>

                <!-- Camera for testing -->
                <div id="cameraSection" style="display: none;" class="mb-4">
                    <div class="camera-container text-center">
                        <video id="video" autoplay style="display: none;" class="img-fluid border rounded shadow"></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        
                        <div class="mt-3">
                            <button type="button" id="start-camera" class="btn btn-primary me-2">
                                <i class="fas fa-video me-1"></i>Bật camera
                            </button>
                            <button type="button" id="capture" class="btn btn-success" style="display: none;">
                                <i class="fas fa-camera me-1"></i>Test nhận diện
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results area -->
                <div id="results" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkUsersBtn = document.getElementById('checkUsers');
    const testRecognitionBtn = document.getElementById('testRecognition');
    const cameraSection = document.getElementById('cameraSection');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCameraBtn = document.getElementById('start-camera');
    const captureBtn = document.getElementById('capture');
    const results = document.getElementById('results');
    let stream = null;

    checkUsersBtn.addEventListener('click', async function() {
        try {
            const response = await fetch('/debug/users');
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle me-2"></i>Thông tin Users trong Database</h5>
                        <p><strong>Tổng số users:</strong> ${data.total_users}</p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tên</th>
                                    <th>Mã NV</th>
                                    <th>Email</th>
                                    <th>Ảnh tồn tại</th>
                                    <th>Face Encoding hợp lệ</th>
                                    <th>Encoding Length</th>
                                    <th>Tạo lúc</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.users.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.employee_id}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="badge ${user.image_exists ? 'bg-success' : 'bg-danger'}">
                                    ${user.image_exists ? 'Có' : 'Không'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${user.encoding_valid ? 'bg-success' : 'bg-danger'}">
                                    ${user.encoding_valid ? 'Hợp lệ' : 'Lỗi'}
                                </span>
                            </td>
                            <td>${user.encoding_length}</td>
                            <td>${user.created_at}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                results.innerHTML = html;
            } else {
                results.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
            }
        } catch (error) {
            results.innerHTML = `<div class="alert alert-danger">Lỗi: ${error.message}</div>`;
        }
    });

    testRecognitionBtn.addEventListener('click', function() {
        cameraSection.style.display = 'block';
        results.innerHTML = '';
    });

    startCameraBtn.addEventListener('click', async function() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            video.style.maxWidth = '400px';
            startCameraBtn.style.display = 'none';
            captureBtn.style.display = 'inline-block';
        } catch (err) {
            alert('Không thể truy cập camera: ' + err.message);
        }
    });

    captureBtn.addEventListener('click', async function() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Gửi dữ liệu để test
        const formData = new FormData();
        formData.append('image_data', imageData);
        
        try {
            const response = await fetch('/debug/test_recognition', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                let html = `
                    <div class="alert alert-info">
                        <h5><i class="fas fa-search me-2"></i>Kết quả Test Nhận Diện</h5>
                        <p><strong>Số khuôn mặt phát hiện:</strong> ${data.faces_detected}</p>
                        <p><strong>Tổng users trong DB:</strong> ${data.total_users_in_db}</p>
                    </div>
                `;
                
                if (data.faces_detected > 0) {
                    data.comparison_results.forEach((face, index) => {
                        html += `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6>Khuôn mặt #${face.face_index + 1}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Tên</th>
                                                    <th>Mã NV</th>
                                                    <th>Khoảng cách</th>
                                                    <th>Khớp</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                        `;
                        
                        face.matches.forEach(match => {
                            html += `
                                <tr class="${match.is_match ? 'table-success' : ''}">
                                    <td>${match.user_name}</td>
                                    <td>${match.employee_id}</td>
                                    <td>${match.distance || match.error || 'N/A'}</td>
                                    <td>
                                        <span class="badge ${match.is_match ? 'bg-success' : 'bg-secondary'}">
                                            ${match.is_match ? 'Có' : 'Không'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="alert alert-warning">Không phát hiện khuôn mặt nào trong ảnh</div>';
                }
                
                results.innerHTML = html;
            } else {
                results.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
            }
        } catch (error) {
            results.innerHTML = `<div class="alert alert-danger">Lỗi: ${error.message}</div>`;
        }
    });
});
</script>
{% endblock %}