{% extends "base.html" %}

{% block title %}Điểm danh - Hệ thống điểm danh khuôn mặt{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center py-3">
                <h4 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Điểm danh bằng khuôn mặt
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <div id="current-time" class="h5 text-primary mb-2"></div>
                    <div id="current-date" class="text-muted"></div>
                </div>

                <div class="camera-section text-center">
                    <div id="camera-container">
                        <video id="video" autoplay style="display: none;" class="img-fluid border rounded shadow"></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" id="start-camera" class="btn btn-primary btn-lg me-2">
                            <i class="fas fa-video me-2"></i>Bật camera
                        </button>
                        <button type="button" id="capture" class="btn btn-success btn-lg" style="display: none;">
                            <i class="fas fa-camera me-2"></i>Điểm danh
                        </button>
                        <button type="button" id="stop-camera" class="btn btn-danger btn-lg" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Tắt camera
                        </button>
                    </div>
                    
                    <div id="loading" style="display: none;" class="mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang xử lý...</span>
                        </div>
                        <div class="mt-2">Đang nhận diện khuôn mặt...</div>
                    </div>
                </div>

                <div id="result-container" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 bg-light">
            <div class="card-body">
                <h6><i class="fas fa-info-circle text-primary me-2"></i>Hướng dẫn điểm danh:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Nhìn thẳng vào camera</li>
                            <li><i class="fas fa-check text-success me-2"></i>Đảm bảo ánh sáng đủ sáng</li>
                            <li><i class="fas fa-check text-success me-2"></i>Không đeo kính đen</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Lần 1 trong ngày: <strong>Check-in</strong></li>
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Từ lần 2 trở đi: <strong>Check-out</strong> (cập nhật thời gian)</li>
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Có thể cập nhật check-out nhiều lần</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCameraBtn = document.getElementById('start-camera');
    const captureBtn = document.getElementById('capture');
    const stopCameraBtn = document.getElementById('stop-camera');
    const loading = document.getElementById('loading');
    const resultContainer = document.getElementById('result-container');
    let stream = null;

    // Cập nhật thời gian
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('vi-VN');
        const dateString = now.toLocaleDateString('vi-VN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        document.getElementById('current-time').textContent = timeString;
        document.getElementById('current-date').textContent = dateString;
    }
    
    updateTime();
    setInterval(updateTime, 1000);

    startCameraBtn.addEventListener('click', async function() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            video.style.maxWidth = '400px';
            startCameraBtn.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            stopCameraBtn.style.display = 'inline-block';
            resultContainer.style.display = 'none';
        } catch (err) {
            showResult('error', 'Không thể truy cập camera: ' + err.message);
        }
    });

    captureBtn.addEventListener('click', function() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Hiển thị loading
        loading.style.display = 'block';
        captureBtn.disabled = true;
        
        // Gửi dữ liệu lên server
        const formData = new FormData();
        formData.append('image_data', imageData);
        
        fetch('/attendance/checkin', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            captureBtn.disabled = false;
            
            if (data.success) {
                showResult('success', data.message, data.type, data.user, data.time, data.is_update);
            } else {
                showResult('error', data.message);
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            captureBtn.disabled = false;
            showResult('error', 'Có lỗi xảy ra: ' + error.message);
        });
    });

    stopCameraBtn.addEventListener('click', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        video.style.display = 'none';
        startCameraBtn.style.display = 'inline-block';
        captureBtn.style.display = 'none';
        stopCameraBtn.style.display = 'none';
    });

    function showResult(type, message, checkinType, user, time, isUpdate) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        let extraInfo = '';
        if (type === 'success' && checkinType && user && time) {
            const typeText = checkinType === 'check_in' ? 'Check-in' : 'Check-out';
            const typeIcon = checkinType === 'check_in' ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
            let typeColor = checkinType === 'check_in' ? 'text-success' : 'text-warning';
            
            // Nếu là cập nhật check-out, đổi màu để nhấn mạnh
            if (isUpdate) {
                typeColor = 'text-info';
            }
            
            extraInfo = `
                <hr>
                <div class="row text-center">
                    <div class="col-md-4">
                        <strong>sinh viên:</strong><br>
                        <span class="text-primary">${user}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Loại:</strong><br>
                        <span class="${typeColor}">
                            <i class="fas ${typeIcon} me-1"></i>${typeText}${isUpdate ? ' (Cập nhật)' : ''}
                        </span>
                    </div>
                    <div class="col-md-4">
                        <strong>Thời gian:</strong><br>
                        <span class="text-info">${time}</span>
                    </div>
                </div>
            `;
        }
        
        resultContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <h5><i class="fas ${icon} me-2"></i>${message}</h5>
                ${extraInfo}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        resultContainer.style.display = 'block';
        
        // Auto-hide after 7 seconds (tăng từ 5s để người dùng đọc được thông báo cập nhật)
        setTimeout(() => {
            resultContainer.style.display = 'none';
        }, 7000);
    }
});
</script>
{% endblock %}